#!/bin/bash
trap "kill 0" SIGINT # Kill all spawned subprocesses on ctrl^c
LOCATION=$(dirname "$0")
source "$LOCATION"/../common_tools
CURRENT_DIR="$PWD"

install_app(){
  echo "‚åõÔ∏è Installing \"$2\" to $1..."
  TEMPORARY_FILE="$TEMPORARY_FILE-$(date +%s)"
  cd "$GO_IOS" || exit
  go run . install --udid="$1" --path="$CURRENT_DIR/$2" &> "$TEMPORARY_FILE"
  if grep -q err "$TEMPORARY_FILE" ; then
    echo "‚ùå Installation to $1 failed!"
    echo "ü§ï Uninstall existing version or troubleshoot the package."
    #TODO refactor sed to jq
    echo "üî• Error details: $(grep 'err' "$TEMPORARY_FILE" | sed 's/^.*: //')"
    exit 1
  fi
  echo "‚úÖ Successfully installed to $1"
}

run_app(){
  echo "(TBD) - see https://github.com/IntergalacticPenguin/mobile-toolkit/pull/210/files"
}

check_args_valid(){
  if [[ "$1" != "-a" ]]; then
    FILE=$1
  else
    FILE=$2
  fi

  if [ ! -f "$CURRENT_DIR/$FILE" ] && [ ! -f "$FILE" ]; then
      abort "ü§∑ Installation file not found!"
  fi

  if [[ "$FILE" != *".ipa" ]]; then
      abort "ü§∑ Unsupported file!"
  fi
}

run(){
  if [[ $1 == "-a" ]]; then
    check_for_update
    ios_get_devices
    for ID in "${IOS_USB_DEVICES[@]}"
     do
      install_app "$ID" "$2" &
    done
    wait
  else
    ios_choose_device
    install_app "$SELECTED_DEVICE" "$1"
  fi
}

check_args_valid "$@"
run "$@"

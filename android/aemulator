#!/bin/bash
LOCATION=$(dirname "$0")
source $LOCATION/../common_tools
LOCAL_EMULATOR_LIST=$LOCATION/../data/toolkit_emulator_list.txt

help(){
  if [[ $1 != "" ]]; then
    echo "🤷‍ Unknown option: $1"
  else
    echo "🤷 Argument missing"
  fi
  echo -e "Use one of the following options:\n  start - choose and launch installed emulator\n  call <number> - receive fake call\n  sms <number> <text> - recieve fake sms\n  gps <lat> <long> - set manual gps location\n  telnet <command> - call telnet command (see README.md)"
}

check_running_emulator(){
  adb devices | grep emulator &> /dev/null
  if [ $? -ne 0 ]; then
    echo "❌ No running emulators"
    yes_or_no "❓ Do you want to start one?"
    if [[ "$RESPONSE" == "y" ||  "$RESPONSE" == "Y" ]];
    then
      launch_emulator
    fi
    exit
  fi
}

get_emulator_list(){
  echo "⏳ Getting Android emulator list..."
  rm -f $LOCAL_EMULATOR_LIST
  ~/Library/Android/sdk/tools/bin/avdmanager list avd | grep Name | awk '{print $2}' >> $LOCAL_EMULATOR_LIST
  if [ "$(cat $LOCAL_EMULATOR_LIST | wc -l)" -eq 0 ]; then
    should_proceed "🤷‍ No emulators installed, install via Android Studio?"
    echo "⏳ Opening Android Studio..."
    open -a /Applications/Android\ Studio.app
    exit
  else
    echo "📱 Available:"
    cat $LOCAL_EMULATOR_LIST | nl
  fi
}

launch_emulator(){
  get_emulator_list

  if [ -z "$1" ]; then
    read -p "📝 Choose: " EMULATOR_INDEX
  else
    EMULATOR_INDEX=$1
  fi
  EMULATOR_NAME=$(sed $EMULATOR_INDEX!d $LOCAL_EMULATOR_LIST)
  if [[ $EMULATOR_INDEX == "" || $EMULATOR_NAME == "" ]]; then
    delete_lastline
    launch_emulator
  else
    echo  "🚀 Launching emulator..."
    nohup $ANDROID_HOME/tools/emulator -avd $EMULATOR_NAME -no-snapshot &> /dev/null &
    rm $LOCAL_EMULATOR_LIST
  fi
}

telnet_command() {
  if [ -z "$1" ];then
    read -p "📝 Insert telnet command: " COMMAND
  else
    COMMAND=$1
  fi
  TOKEN=$(cat $HOME/.emulator_console_auth_token)
  { echo "o localhost 5554"; sleep 1; echo "auth $TOKEN"; sleep 1; echo $COMMAND; } | telnet &> /dev/null
  echo "✅ Done"
}

call(){
  if [ -z "$1" ];then
    read -p "📝 Insert caller number: " NUMBER
  else
    NUMBER=$1
  fi
  echo "📞 Making a call..."
  telnet_command "gsm call $NUMBER"
}

send_sms(){
  if [ -z "$1" ];then
    read -p "📝 Insert sender number: " NUMBER
  else
    NUMBER=$1
  fi

  if [ -z "$2" ];then
    read -p "📝 Insert text: " TEXT
  else
    TEXT=$2
  fi

  echo "📝 Sending fake SMS..."
  telnet_command "sms send $NUMBER $TEXT"
}

set_gps(){
  if [ -z "$1" ];then
    read -p "📝 Insert latitude: " LAT
  else
    LAT=$1
  fi

  if [ -z "$2" ];then
    read -p "📝 Insert longtitude: " LONG
  else
    LONG=$2
  fi

  echo "🌎 Setting manual GPS location..."
  telnet_command "geo fix $LONG $LAT"
}

check_for_update

case $1 in
  'start')
    launch_emulator "$2"
    ;;
  'call')
    check_running_emulator
    call "$2"
    ;;
  'sms')
    check_running_emulator
    send_sms "$2" "$3"
    ;;
  'gps')
   check_running_emulator
   set_gps "$2" "$3"
    ;;
  'telnet')
   check_running_emulator
   telnet_command "$2"
    ;;
   *)
    help "$1"
    ;;
esac

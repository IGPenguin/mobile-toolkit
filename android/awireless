#!/bin/bash
LOCATION=$(dirname "$0")
source $LOCATION/../common_tools

get_device_ip(){
  android_choose_device
  DEVICE_IP=$(adb -s $SELECTED_DEVICE shell ip route | awk '{print $9}')
  DEVICE_IP=$(echo $DEVICE_IP | cut -d' ' -f1)
}

setup_network_connection(){
  echo "ðŸŒŽ Connecting the device via local network..."
  adb -s $SELECTED_DEVICE tcpip 5555 &> /dev/null
  echo "ðŸŒŽ Getting device IP..."
  delete_lastline
  echo "ðŸŒŽ Device IP: $DEVICE_IP"
  echo "ðŸŒŽ Connecting..."
  STATUS=$(adb connect "$DEVICE_IP:5555")

  echo $STATUS | grep "refused" && echo "âŒ Connection refused - already connected?" && return
  echo "âœ… Connected successfully, you can unplug the USB cable"
}

setup_usb_connection(){
  echo "ðŸ”Œ Connecting the device via USB..."
  adb disconnect "$DEVICE_IP:5555" &> /dev/null
  adb usb &> /dev/null
}

get_device_ip
if [ "$SELECTED_DEVICE" == "$DEVICE_IP:5555" ]; then
  setup_usb_connection
else
  setup_network_connection
fi

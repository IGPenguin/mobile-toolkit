#!/bin/bash

#GET device list
devices=()
for line in `adb devices | grep -v "List"  | awk '{print $1}'`
do
  device=`echo $line | awk '{print $1}'`
  devices+=("$device")
done

#If mutliple available
if [ ${#devices[@]} -gt 1 ]
then
   echo Multiple devices available: ${devices[@]}
   select opt in "${devices[@]}"
   do
     case $opt in
        *) selected=$opt;break; ;;
      esac
  done
else
   selected="${devices[0]}"
fi

read -r -p "Are you sure, you want to remove ALL installed packages and delete the contents of /sdcard/Download on $selected? [y/n] " response
case "$response" in
    [yY]) 
        ;;
    *)
        exit
        ;;
esac

IFS=$'\n'
packages=($(adb -s $selected shell 'pm list packages -3 -f' | sed -e 's/.*=//' | sort))
unset IFS

for pkg in "${packages[@]}"
do

   if [[ $pkg = *"funtaster"* ]]; then
      echo "Skipping $pkg"
      continue
   fi

   pkg=${pkg%$'\r'} #removes trailing \r
   echo Uninstalling $pkg
   adb -s $selected shell "pm uninstall $pkg"

done

echo Clearing /sdcard/Download
adb -s $selected shell rm -r /sdcard/Download/*


#!/bin/bash

##########################
### ANDROID SECTION

android_choose_device() {
#Populate array with device ids
DEVICES=()
for LINE in `adb devices | grep -v "List"  | awk '{print $1}'`
do
  DEVICE=`echo $LINE | awk '{print $1}'`
  DEVICES+=("$DEVICE")
done

#No device connected
if [ ${#DEVICES[@]} -eq 0 ]
then
   echo No device connected, aborting...
   exit
fi

#Gather device info and choose device
if [ ${#DEVICES[@]} -gt 1 ]
then
   NUMBER=1
   echo Multiple devices available:
   for ID in "${DEVICES[@]}"
    do
      MANUFACTURER=$(adb -s $ID shell getprop ro.product.manufacturer | tr -cd '[[:alnum:]]._-')
      MODEL=$(adb -s $ID shell getprop ro.product.model | tr -cd '[[:alnum:]]._-')
      VERSION=$(adb -s $ID shell getprop ro.build.version.release | tr -cd '[[:alnum:]]._-')
      SDK=$(adb -s $ID shell getprop ro.build.version.sdk | tr -cd '[[:alnum:]]._-')
      INFO=$(printf "%s)\n%s\n%s\n%s\n(API %s)\n-\n%s" "$NUMBER" "$MANUFACTURER" "$MODEL" "$VERSION" "$SDK" "$ID")
      echo $INFO
      ((NUMBER++))
    done

    read -p "Select a device: " CHOICE
    while :;
    do
    if ((CHOICE <= 0 || CHOICE > ${#DEVICES[@]})); then
      echo -en "\033[1A\033[2K" #deletes last echoed line in terminal
      read -p "Invalid input, try again: " CHOICE
    else
      break
    fi
    done
    SELECTED_DEVICE=${DEVICES[(($CHOICE-1))]}
else
   SELECTED_DEVICE="${DEVICES[0]}"
fi

SELECTED_DEVICE_MODEL=$(adb -s $SELECTED_DEVICE shell getprop ro.product.model | tr -cd '[[:alnum:]]._-')
SELECTED_DEVICE_SDK=$(adb -s $SELECTED_DEVICE shell getprop ro.build.version.sdk | tr -cd '[[:alnum:]]._-')
}

android_is_installed() {
adb -s $SELECTED_DEVICE shell pm list packages -f | sed -e 's/.*=//' | grep $1 &> /dev/null
EXIT_CODE=$?
if [ $EXIT_CODE -ne 0 ]; then
    echo "ü§∑‚Äç Package $1 is not installed."
    exit
fi
}

##########################
### IOS SECTION

ios_check_developer_image(){
  IS_MOUNTED=$(ideviceimagemounter -l)
  if [ ${#IS_MOUNTED} -eq 0 ] ; then
    read -r -p "Developer image probably not mounted, do you want to launch Xcode? [y/n] " RESPONSE
    case "$RESPONSE" in
        [yY])
            ;;
        *)
            exit
            ;;
    esac
    open -a Xcode
    sleep 8
  fi
}

ios_choose_device(){
  IOS_DEVICES=( $(idevice_id -l) )
  echo "${IOS_DEVICES[*]}"
}

ios_get_device_info(){
  SELECTED_DEVICE_MODEL=$(ideviceinfo | grep "HardwareModel" | cut -d\   -f2)
  SELECTED_DEVICE_VERSION=$(ideviceinfo | grep "ProductVersion" | cut -d\   -f2)
}

ios_get_package_list(){
  echo "üîç Detecting packages..."
  PACKAGE_LIST=()
  ALL_INFO_LIST=($(ideviceinstaller -l -o list_user | tail -n +2 | sed -e 's/.*=//' | sort))

  for PACKAGE in "${ALL_INFO_LIST[@]}" #remove redundant information
    do
      echo "$PACKAGE" | grep -q '"'
      EXIT_CODE=$?

      if [ $EXIT_CODE -ne 0 ]; then
        PACKAGE=${PACKAGE%,*}
        PACKAGE_LIST+=($PACKAGE)
      fi
    done

  if [ ${#PACKAGE_LIST[@]} -eq 0 ]; then
    echo "ü§∑‚Äç No packages installed."
    exit
  fi
}

#####
### COMMON SECTION
should_proceed(){
read -r -p "$1 [y/n] " RESPONSE
case "$RESPONSE" in
    [yY])
        ;;
    *)
        exit
        ;;
esac
}
